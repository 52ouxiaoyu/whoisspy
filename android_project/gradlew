#!/usr/bin/env bash

##############################################################################
# çœŸæ­£çš„GradleåŒ…è£…å™¨è„šæœ¬ - ç”¨äºæ„å»ºAndroid APK
##############################################################################

# è®¾ç½®é”™è¯¯æ—¶é€€å‡º
set -e

# å®šä¹‰å˜é‡
APP_BASE_NAME=$(basename "$0")
APP_HOME=$(cd "$(dirname "$0")" && pwd)
GRADLE_VERSION="8.4"
GRADLE_DIST_URL="https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
GRADLE_ZIP="gradle-${GRADLE_VERSION}-bin.zip"
GRADLE_USER_HOME="$HOME/.gradle"
GRADLE_WRAPPER_DIR="$GRADLE_USER_HOME/wrapper/dists/gradle-${GRADLE_VERSION}-bin"
GRADLE_HOME="$GRADLE_WRAPPER_DIR/2ahq288yup5c86pi9438cgk0b"

# æ˜¾ç¤ºæ„å»ºä¿¡æ¯
echo "===== Androidé¡¹ç›®æ„å»º ====="
echo "é¡¹ç›®è·¯å¾„: $APP_HOME"
echo "ä½¿ç”¨Gradleç‰ˆæœ¬: $GRADLE_VERSION"

# æ£€æŸ¥Javaç¯å¢ƒ
if ! command -v java &> /dev/null; then
    echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°Javaã€‚è¯·ç¡®ä¿å·²å®‰è£…JDK 11æˆ–17ã€‚"
    exit 1
fi

JAVA_VERSION=$(java -version 2>&1 | head -1 | awk -F[\"_] '{print $2}')
echo "âœ… Javaç‰ˆæœ¬: $JAVA_VERSION"

# æ£€æŸ¥Android SDK
SDK_PATH="/Users/wujun/Library/Android/sdk"
if [ ! -d "$SDK_PATH" ]; then
    echo "âŒ é”™è¯¯: Android SDKè·¯å¾„ä¸å­˜åœ¨: $SDK_PATH"
    echo "è¯·å®‰è£…Android SDKå¹¶è®¾ç½®æ­£ç¡®çš„è·¯å¾„"
    exit 1
fi
echo "âœ… Android SDKè·¯å¾„: $SDK_PATH"

# åˆ›å»ºå¿…è¦çš„ç›®å½•
mkdir -p "$APP_HOME/gradle/wrapper"
mkdir -p "$GRADLE_WRAPPER_DIR"

# åˆ›å»ºgradle-wrapper.properties
cat > "$APP_HOME/gradle/wrapper/gradle-wrapper.properties" << EOF
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF

echo "âœ… å·²é…ç½®GradleåŒ…è£…å™¨"

# ä¸‹è½½Gradleï¼ˆå¦‚æœéœ€è¦ï¼‰
GRADLE_BIN_PATH=""

# æ£€æŸ¥æ˜¯å¦å·²å®‰è£…Gradle
if [ -d "$GRADLE_WRAPPER_DIR" ]; then
    # æŸ¥æ‰¾å®é™…çš„Gradleå®‰è£…ç›®å½•ï¼ˆå¤„ç†éšæœºç”Ÿæˆçš„å“ˆå¸Œç›®å½•åï¼‰
    GRADLE_INSTALL_DIR=$(find "$GRADLE_WRAPPER_DIR" -name "gradle-${GRADLE_VERSION}" -type d 2>/dev/null || echo "")
    if [ -n "$GRADLE_INSTALL_DIR" ] && [ -f "$GRADLE_INSTALL_DIR/bin/gradle" ]; then
        GRADLE_BIN_PATH="$GRADLE_INSTALL_DIR/bin/gradle"
    fi
fi

if [ -z "$GRADLE_BIN_PATH" ]; then
    echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½Gradle ${GRADLE_VERSION}..."
    
    # ä¸‹è½½Gradle zip
    curl -s -L "$GRADLE_DIST_URL" -o "$APP_HOME/$GRADLE_ZIP"
    
    # è§£å‹Gradleåˆ°ä¸´æ—¶ç›®å½•
    echo "ğŸ”„ æ­£åœ¨è§£å‹Gradle..."
    TEMP_GRADLE_DIR="$APP_HOME/temp_gradle"
    mkdir -p "$TEMP_GRADLE_DIR"
    unzip -q "$APP_HOME/$GRADLE_ZIP" -d "$TEMP_GRADLE_DIR"
    
    # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
    mkdir -p "$GRADLE_WRAPPER_DIR"
    
    # å¤åˆ¶è§£å‹åçš„æ–‡ä»¶åˆ°ç›®æ ‡ä½ç½®
    cp -r "$TEMP_GRADLE_DIR/gradle-${GRADLE_VERSION}" "$GRADLE_WRAPPER_DIR/"
    
    # æ‰¾åˆ°æ­£ç¡®çš„GradleäºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„
    GRADLE_BIN_PATH="$GRADLE_WRAPPER_DIR/gradle-${GRADLE_VERSION}/bin/gradle"
    
    # æ¸…ç†
    rm -rf "$TEMP_GRADLE_DIR" "$APP_HOME/$GRADLE_ZIP"
    
    echo "âœ… Gradle ${GRADLE_VERSION}å®‰è£…å®Œæˆ"
else
    echo "âœ… Gradle ${GRADLE_VERSION}å·²å­˜åœ¨"
fi

# ç¡®ä¿Gradleå¯æ‰§è¡Œ
if [ -f "$GRADLE_BIN_PATH" ]; then
    chmod +x "$GRADLE_BIN_PATH"
else
    echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°Gradleå¯æ‰§è¡Œæ–‡ä»¶"
    exit 1
fi

# è®¾ç½®ç¯å¢ƒå˜é‡
export ANDROID_HOME="$SDK_PATH"
export GRADLE_USER_HOME

# æ‰§è¡Œæ„å»º
if [ "$1" == "assembleDebug" ]; then
    echo "ğŸ”¨ å¼€å§‹æ„å»ºDebugç‰ˆæœ¬APK..."
    # è°ƒç”¨å®é™…çš„Gradleæ‰§è¡Œæ„å»º
    "$GRADLE_BIN_PATH" assembleDebug
    
    # æ£€æŸ¥æ„å»ºç»“æœ
    if [ -f "$APP_HOME/app/build/outputs/apk/debug/app-debug.apk" ]; then
        echo "âœ… APKæ„å»ºæˆåŠŸï¼"
        echo "ğŸ“ APKæ–‡ä»¶ä½ç½®: $APP_HOME/app/build/outputs/apk/debug/app-debug.apk"
        echo "\nğŸš€ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…åˆ°è®¾å¤‡:"
        echo "   adb install $APP_HOME/app/build/outputs/apk/debug/app-debug.apk"
    else
        echo "âŒ APKæ„å»ºå¤±è´¥æˆ–æ–‡ä»¶ä¸å­˜åœ¨"
        echo "è¯·æ£€æŸ¥ä¸Šé¢çš„æ„å»ºé”™è¯¯ä¿¡æ¯"
        exit 1
    fi
else
    # å¦‚æœæ²¡æœ‰æŒ‡å®šassembleDebugï¼Œæ‰§è¡Œç”¨æˆ·æä¾›çš„å‘½ä»¤æˆ–æ˜¾ç¤ºå¸®åŠ©
    if [ $# -eq 0 ]; then
        echo "ğŸ“‹ å¯ç”¨å‘½ä»¤:"
        echo "   ./gradlew assembleDebug - æ„å»ºDebugç‰ˆæœ¬APK"
        echo "   ./gradlew assembleRelease - æ„å»ºReleaseç‰ˆæœ¬APK"
        echo "   ./gradlew clean - æ¸…ç†æ„å»ºç¼“å­˜"
        echo "   ./gradlew tasks - åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡"
        
        # æ¼”ç¤ºæ„å»ºæµç¨‹
        echo "\nğŸ”¨ æ‰§è¡Œæ¼”ç¤ºæ„å»ºæµç¨‹..."
        mkdir -p "$APP_HOME/app/build/outputs/apk/debug"
        
        # åˆ›å»ºæ¼”ç¤ºAPKä¿¡æ¯æ–‡ä»¶
        echo "æ„å»ºæ¼”ç¤ºå®Œæˆï¼" > "$APP_HOME/app/build/outputs/apk/debug/build_demo.txt"
        echo "è¦æ„å»ºçœŸæ­£çš„APKï¼Œè¯·è¿è¡Œ: ./gradlew assembleDebug" > "$APP_HOME/app/build/outputs/apk/debug/README.txt"
        
        echo "âœ… æ¼”ç¤ºå®Œæˆã€‚è¯·è¿è¡Œ './gradlew assembleDebug' æ„å»ºçœŸå®APKã€‚"
    else
        # æ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„Gradleå‘½ä»¤
        echo "ğŸ”¨ æ‰§è¡ŒGradleå‘½ä»¤: $@"
        "$GRADLE_BIN_PATH" "$@"
    fi
fi

# æ˜¾ç¤ºå®Œæˆä¿¡æ¯
echo "\nğŸ‰ æ„å»ºæµç¨‹å®Œæˆï¼"